<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inventario Ruffino ‚Äî EAN (universale con ZBar polyfill/wasm)</title>

  <!-- ZXing (UMD) per fallback -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <!-- zbar-wasm + polyfill da jsDelivr (auto-caricano zbar.wasm) -->
  <script src="https://cdn.jsdelivr.net/npm/@undecaf/zbar-wasm@0.9.15/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@undecaf/barcode-detector-polyfill@0.9.21/dist/index.js"></script>


  <!-- ZBar-based BarcodeDetector polyfill (UMD) -->
  <script src="https://unpkg.com/@undecaf/barcode-detector-polyfill@1.3.8/dist/barcode-detector-polyfill.umd.js"></script>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 14px; }
    h1 { margin: 0 0 12px; }
    .card { border: 1px solid #ccc; border-radius: 12px; padding: 14px; max-width: 860px; margin-inline: auto; }
    label { display:block; margin: 6px 0 4px; font-weight: 600; }
    input, select, button { font-size: 16px; padding: 10px; box-sizing: border-box; }
    button { cursor: pointer; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 10px; }
    .controls > * { flex: 1; min-width: 160px; }
    .muted { color: #666; font-size: 14px; }
    .ok { color: #0a7; }
    .err { color: #c00; white-space: pre-wrap; }
    #scanner-section { display:none; }
    #status { margin-top: 8px; }
    #last-scan { margin-top: 8px; font-weight: 700; font-size: 18px; }
    #counter { margin-top: 6px; font-size: 15px; }

    .viewport {
      position: relative; width: 100%; max-width: 860px; margin-inline: auto;
      aspect-ratio: 16/9; background: #000; border: 1px solid #999; border-radius: 12px; overflow: hidden;
    }
    .viewport video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; background: #000; transform-origin: 50% 50%; }
    .aim { pointer-events: none; position: absolute; inset: 12%; border: 3px dashed rgba(0,255,0,0.35); border-radius: 10px; z-index: 5; }
    #flash { position: fixed; inset: 0; background: rgba(0,200,0,0.35); pointer-events: none; opacity: 0; transition: opacity 120ms ease; }
    #flash.show { opacity: 1; }

    .range-row { display:flex; align-items:center; gap:8px; }
    .range-row input[type="range"] { flex: 1; }

    .rot90 .viewport video { transform: rotate(90deg); }

    .pillbar { display:flex; gap:8px; flex-wrap:wrap; }
    .pillbar button { padding: 8px 12px; border-radius: 999px; border: 1px solid #aaa; background: #f3f3f3; }
  </style>
</head>
<body>
  <h1>üì¶ Inventario Ruffino ‚Äî EAN (universale)</h1>

  <div id="login-section" class="card">
    <p><b>Accesso</b></p>
    <label for="username">Utente</label>
    <input id="username" type="text" placeholder="Emporio" autocomplete="username" />
    <label for="password">Password</label>
    <input id="password" type="password" placeholder="Lallero" autocomplete="current-password" />
    <button id="login-btn" style="margin-top:10px;">Entra</button>
    <div id="login-msg" class="muted"></div>
  </div>

  <div id="scanner-section" class="card">
    <div class="controls">
      <div>
        <label for="logicalToggle">Fotocamera logica (consigliata)</label>
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="logicalToggle" checked />
          Usa profilo "environment" senza deviceId
        </label>
      </div>
      <div>
        <label for="compatToggle">Modalit√† compatibilit√†</label>
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="compatToggle" />
          Forza 1280√ó720 @ 30fps
        </label>
      </div>
      <div>
        <label for="nativeToggle">Forza motore nativo</label>
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="nativeToggle" />
          Usa sempre BarcodeDetector (se disponibile)
        </label>
      </div>
      <div>
        <label for="cameraSelect">Sorgente video (se logica OFF)</label>
        <select id="cameraSelect"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="restart-btn">Riavvia</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="rotate-btn">Ruota 90¬∞</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="torch-btn">Torcia: Off</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="beep-toggle" checked />
          BIP audio
        </label>
      </div>
    </div>

    <div class="range-row">
      <label for="zoom">Zoom</label>
      <input id="zoom" type="range" min="1" max="6" step="0.1" value="1.8" />
      <span id="zoomValue" class="muted">1.8√ó</span>
    </div>

    <div class="pillbar" style="margin:6px 0 10px;">
      <button data-zoom="1">1√ó</button>
      <button data-zoom="1.5">1.5√ó</button>
      <button data-zoom="2">2√ó (tele leggero)</button>
      <button data-zoom="3">3√ó</button>
    </div>

    <div id="stage" class="stage">
      <div class="viewport" id="viewport">
        <video id="video" playsinline muted autoplay></video>
        <div class="aim"></div>
      </div>
    </div>

    <div id="status" class="muted">In attesa permesso fotocamera‚Ä¶</div>
    <div id="last-scan"></div>
    <div id="counter" class="muted">Scansioni questa sessione: 0</div>
    <div id="error" class="err"></div>
    <pre id="diag" class="muted" style="white-space:pre-wrap;max-height:160px;overflow:auto;margin-top:6px;"></pre>

    <details style="margin-top:10px;">
      <summary>Consigli AF / multi-camera</summary>
      <ul class="muted">
        <li>Con <b>Fotocamera logica</b> il telefono usa la pipeline multifocale ‚Üí AF migliore.</li>
        <li>Usa i preset <b>1√ó / 1.5√ó / 2√ó / 3√ó</b> per ‚Äúsaltare‚Äù alla lente giusta.</li>
        <li>Se alcuni modelli faticano, attiva <b>Modalit√† compatibilit√†</b>.</li>
        <li>Buona luce; se serve usa <b>Torcia</b> (manuale).</li>
      </ul>
    </details>
  </div>

  <div id="flash"></div>

  <script>
    // === CONFIG ===
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbx_aDKqFr15qhLoZvSV3aAo7hbzKNtJ73LLIWgZrq2xLm3ONjxJhigHwbi19qb1DdIq0w/exec";
    // ZBar polyfill WASM: tenta CDN; se fallisce useremo ./zbar.wasm (metti il file accanto a index.html)
    const ZBAR_WASM_CDN = "https://unpkg.com/@undecaf/barcode-detector-polyfill@1.3.8/dist/worker/zbar.wasm";
    // ==============

    let usingNative = false;    // true se usiamo BarcodeDetector (nativo o polyfill)
    let codeReader = null;      // ZXing (fallback)
    let streamTrack = null;
    let currentDeviceId = null;
    let audioCtx = null;
    let sessionCount = 0;
    let lastSent = { code: null, time: 0 };
    let rotated = false;

    const ua = navigator.userAgent.toLowerCase();
    const autoCompat = /sm-s90|s22|sm-s901|sm-s906|sm-s908|mate 20|ane-lx|huawei/.test(ua);

    const els = {
      loginSection: document.getElementById('login-section'),
      scannerSection: document.getElementById('scanner-section'),
      loginBtn: document.getElementById('login-btn'),
      loginMsg: document.getElementById('login-msg'),
      stage: document.getElementById('stage'),
      viewport: document.getElementById('viewport'),
      video: document.getElementById('video'),
      cameraSelect: document.getElementById('cameraSelect'),
      logicalToggle: document.getElementById('logicalToggle'),
      compatToggle: document.getElementById('compatToggle'),
      nativeToggle: document.getElementById('nativeToggle'),
      restartBtn: document.getElementById('restart-btn'),
      rotateBtn: document.getElementById('rotate-btn'),
      torchBtn: document.getElementById('torch-btn'),
      beepToggle: document.getElementById('beep-toggle'),
      status: document.getElementById('status'),
      lastScan: document.getElementById('last-scan'),
      counter: document.getElementById('counter'),
      error: document.getElementById('error'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      zoom: document.getElementById('zoom'),
      zoomValue: document.getElementById('zoomValue'),
      diag: document.getElementById('diag'),
    };

    // Inizializza ZBar polyfill se manca BarcodeDetector nativo
    (async () => {
      if (!('BarcodeDetector' in window) && window.BarcodeDetectorPolyfill) {
        try {
          // prima proviamo via CDN
          window.BarcodeDetectorPolyfill.wasmUrl = ZBAR_WASM_CDN;
          window.BarcodeDetector = window.BarcodeDetectorPolyfill;
          // test rapido: crea e distruggi per forzare il download
          const test = new window.BarcodeDetector({ formats: ['ean_13'] });
          await test.detect(document.createElement('canvas')); // non lancia, ma forza init
        } catch (e) {
          console.warn('CDN zbar.wasm non accessibile, uso ./zbar.wasm locale', e);
          // fallback a file locale (metti zbar.wasm nella stessa cartella del sito)
          try {
            window.BarcodeDetectorPolyfill.wasmUrl = './zbar.wasm';
            window.BarcodeDetector = window.BarcodeDetectorPolyfill;
          } catch (e2) {
            console.error('Impossibile inizializzare il polyfill ZBar.', e2);
          }
        }
      }
    })();

    // Preset zoom
    document.querySelectorAll('.pillbar [data-zoom]').forEach(btn => {
      btn.addEventListener('click', () => {
        els.zoom.value = btn.dataset.zoom;
        els.zoom.dispatchEvent(new Event('input'));
      });
    });

    // Eventi UI
    els.loginBtn.addEventListener('click', doLogin);
    els.restartBtn.addEventListener('click', restartEngine);
    els.rotateBtn.addEventListener('click', () => { rotated = !rotated; toggleRotation(); });
    els.torchBtn.addEventListener('click', toggleTorch);
    els.zoom.addEventListener('input', onZoomInput);
    els.logicalToggle.addEventListener('change', () => {
      if (!els.logicalToggle.checked) enumerateCameras();
    });
    els.nativeToggle.addEventListener('change', () => restartEngine());

    function toggleRotation() {
      if (rotated) els.stage.classList.add('rot90'); else els.stage.classList.remove('rot90');
    }

    async function doLogin() {
      const u = els.username.value.trim();
      const p = els.password.value.trim();
      if (!u || !p) { els.loginMsg.textContent = "Inserisci utente e password."; return; }
      window._username = u; window._password = p;

      try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); await audioCtx.resume(); } catch {}

      if (autoCompat) els.compatToggle.checked = true;

      els.loginSection.style.display = 'none';
      els.scannerSection.style.display = 'block';
      await initEngine();
    }

    async function initEngine() {
      els.status.textContent = "Inizializzazione‚Ä¶";
      els.error.textContent = "";
      sessionCount = 0; updateCounter();
      lastSent = { code: null, time: 0 };

      if (!els.logicalToggle.checked) await enumerateCameras();
      await startScannerUniversal();  // nativo (o polyfill) ‚Üí ZXing fallback
    }

    async function enumerateCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        els.cameraSelect.innerHTML = "";
        cams.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `Camera ${d.deviceId.slice(0,6)}‚Ä¶`;
          els.cameraSelect.appendChild(opt);
        });
        const back = cams.find(d => /back|rear|posteriore/i.test(d.label || ""));
        currentDeviceId = back ? back.deviceId : (cams[0] && cams[0].deviceId) || null;
        if (currentDeviceId) els.cameraSelect.value = currentDeviceId;
      } catch (e) {}
    }

    async function restartEngine() {
      await stopAll();
      await startScannerUniversal();
    }

    async function stopAll() {
      els.status.textContent = "Arresto‚Ä¶";
      els.error.textContent = "";
      usingNative = false;
      try { if (codeReader) await codeReader.reset(); } catch {}
      try {
        if (streamTrack) { streamTrack.stop(); streamTrack = null; }
        if (els.video.srcObject) {
          els.video.srcObject.getTracks().forEach(t => t.stop());
          els.video.srcObject = null;
        }
      } catch {}
    }

    // --------- UNIVERSAL STARTER: BarcodeDetector (nativo o ZBar) -> ZXing ---------
    async function startScannerUniversal() {
      els.status.textContent = "Avvio scanner‚Ä¶";
      await printDiagnostics();

      const wantNative = els.nativeToggle.checked;

      if (window.BarcodeDetector && (wantNative || true)) {
        try {
          const sup = await (BarcodeDetector.getSupportedFormats?.() || []);
          const needed = ['ean_13','ean_8','upc_a'];
          const ok = needed.some(f => sup.includes(f));
          const formats = ok ? needed : (sup.length ? sup : needed);
          const detector = new BarcodeDetector({ formats });
          await startNativeDetector(detector);
          usingNative = true;
          els.status.innerHTML = '<span class="ok">Scanner nativo/ZBar attivo ‚úîÔ∏è</span>';
          return;
        } catch (e) {
          console.warn('BarcodeDetector non disponibile/errore, passo a ZXing', e);
        }
      }

      usingNative = false;
      await startZXing();
    }

    // --------- BRANCH BarcodeDetector (nativo o polyfill ZBar) ---------
    async function startNativeDetector(detector) {
      const logical = els.logicalToggle.checked;
      const compat = els.compatToggle.checked;

      const constraints = {
        audio: false,
        video: Object.assign(
          {},
          logical ? { facingMode: { ideal: 'environment' } }
                  : (els.cameraSelect.value ? { deviceId: { exact: els.cameraSelect.value } }
                                            : { facingMode: { ideal: 'environment' } }),
          compat ? { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30, max: 30 } }
                 : { width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 60, max: 60 } }
        )
      };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      els.video.srcObject = stream;
      await els.video.play();

      streamTrack = stream.getVideoTracks()[0] || null;
      const caps = streamTrack?.getCapabilities?.() || {};
      els.torchBtn.textContent = caps.torch ? "Torcia: Off" : "Torcia: N/D";
      await applyZoom(parseFloat(els.zoom.value), true).catch(()=>{});

      const tick = async () => {
        if (!usingNative) return;
        try {
          const codes = await detector.detect(els.video);
          if (codes && codes.length) {
            const raw = String(codes[0].rawValue || '').trim();
            if (/^(\d{8}|\d{12}|\d{13})$/.test(raw)) {
              handleDetection(raw);
            }
          }
        } catch (e) {
          console.warn('Native/ZBar detect err:', e);
        }
        setTimeout(tick, 120);
      };
      tick();
    }

    // --------- ZXING BRANCH ---------
    function buildHintsEAN() {
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.EAN_8,
        ZXing.BarcodeFormat.UPC_A
      ]);
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
      return hints;
    }

    async function startZXing() {
      const logical = els.logicalToggle.checked;
      const compat = els.compatToggle.checked;

      codeReader = new ZXing.BrowserMultiFormatReader(buildHintsEAN());

      const deviceId = logical ? null : (els.cameraSelect.value || currentDeviceId || null);

      const constraints = {
        audio: false,
        video: Object.assign(
          {},
          deviceId ? { deviceId: { exact: deviceId } } : { facingMode: { ideal: "environment" } },
          compat ? { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30, max: 30 } }
                 : { width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 60, max: 60 } },
          { focusMode: "continuous", advanced: [{ focusMode: "continuous" }] }
        )
      };

      try {
        await codeReader.decodeFromConstraints(constraints, els.video, onZXingFrame);

        const s = els.video.srcObject;
        if (s && s.getVideoTracks().length) {
          streamTrack = s.getVideoTracks()[0];
          const caps = streamTrack.getCapabilities?.() || {};
          els.torchBtn.textContent = caps.torch ? "Torcia: Off" : "Torcia: N/D";
          await applyZoom(parseFloat(els.zoom.value), true).catch(()=>{});
        }

        els.status.innerHTML = `<span class="ok">ZXing attivo ‚úîÔ∏è ${logical ? "(logico)" : "(device)"} ${compat ? "‚Ä¢ compat" : ""}</span>`;
      } catch (err) { handleError(err); }
    }

    function onZXingFrame(result, err) {
      if (result) {
        const code = result.getText().trim();
        if (!/^(\d{8}|\d{12}|\d{13})$/.test(code)) return; // EAN-8 / UPC-A / EAN-13
        handleDetection(code);
      }
      if (err && !(err instanceof ZXing.NotFoundException)) console.warn(err);
    }

    // --------- TORCIA / ZOOM / UTILITY ---------
    async function toggleTorch() {
      if (!streamTrack) return;
      try {
        const caps = streamTrack.getCapabilities?.() || {};
        if (!caps.torch) { els.error.textContent = "Torcia non supportata."; return; }
        const on = streamTrack.getSettings().torch || false;
        await streamTrack.applyConstraints({ advanced: [{ torch: !on }] });
        els.torchBtn.textContent = `Torcia: ${!on ? "On" : "Off"}`;
      } catch (e) { handleError(e); }
    }

    function onZoomInput() {
      const z = parseFloat(els.zoom.value);
      els.zoomValue.textContent = `${z.toFixed(1)}√ó`;
      applyZoom(z).catch(handleError);
    }

    async function applyZoom(z, quiet=false) {
      if (!streamTrack) return;
      try {
        const caps = streamTrack.getCapabilities?.() || {};
        if (!("zoom" in caps)) { if (!quiet) els.error.textContent = "Zoom non supportato."; return; }
        const min = caps.zoom.min ?? 1, max = caps.zoom.max ?? 6;
        const clamped = Math.max(min, Math.min(max, z));
        await streamTrack.applyConstraints({ advanced: [{ zoom: clamped }] });
      } catch (e) { if (!quiet) throw e; }
    }

    // --------- DETECTION COMUNE ---------
    function handleDetection(code) {
      const now = Date.now();
      if (lastSent.code === code && (now - lastSent.time) < 900) return; // debounce ~1s
      lastSent = { code, time: now };

      confirmEffect();
      els.lastScan.textContent = `Ultimo codice: ${code}`;
      sessionCount++; updateCounter();

      sendCode(code).catch(handleError);
    }

    function updateCounter() { els.counter.textContent = `Scansioni questa sessione: ${sessionCount}`; }

    function confirmEffect() {
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (els.beepToggle.checked) {
          const o = audioCtx.createOscillator(), g = audioCtx.createGain();
          o.type = "square"; o.frequency.value = 920;
          g.gain.value = 0.0001; o.connect(g); g.connect(audioCtx.destination);
          o.start();
          const t0 = audioCtx.currentTime;
          g.gain.exponentialRampToValueAtTime(0.22, t0 + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
          o.stop(t0 + 0.2);
        }
      } catch {}
      if (navigator.vibrate) navigator.vibrate(50);
      const flash = document.getElementById('flash');
      flash.classList.add('show'); setTimeout(() => flash.classList.remove('show'), 110);
    }

    async function sendCode(codice) {
      els.status.textContent = "Invio al foglio‚Ä¶";
      const resp = await fetch(ENDPOINT, {
        method: "POST",
        body: JSON.stringify({ username: window._username, password: window._password, codice }),
      });
      const json = await resp.json();
      if (json.success) {
        els.status.innerHTML = `<span class="ok">Registrato ‚úîÔ∏è ‚Äî pronto per il prossimo</span>`;
      } else {
        throw new Error(json.error || "Errore server");
      }
    }

    function handleError(e) {
      console.error(e);
      els.error.textContent = (e && e.message) ? e.message : String(e);
      els.status.textContent = "Errore.";
      if (/NotAllowedError|Permission/i.test(els.error.textContent)) {
        els.error.textContent += "\nConcedi il permesso fotocamera (Impostazioni sito ‚Üí Fotocamera: Consenti).";
      }
      if (/NotFoundError|device not found/i.test(els.error.textContent)) {
        els.error.textContent += "\nNessuna camera trovata o permesso negato. HTTPS richiesto.";
      }
    }

    // --- Diagnostica ---
    async function printDiagnostics() {
      try {
        const supportsNative = !!window.BarcodeDetector;
        let supFormats = [];
        if (supportsNative && BarcodeDetector.getSupportedFormats) {
          supFormats = await BarcodeDetector.getSupportedFormats();
        }

        const sc = navigator.mediaDevices.getSupportedConstraints
          ? navigator.mediaDevices.getSupportedConstraints()
          : {};
        const uaFull = navigator.userAgent;

        let settings = null, caps = null;
        if (streamTrack) {
          settings = streamTrack.getSettings ? streamTrack.getSettings() : null;
          caps = streamTrack.getCapabilities ? streamTrack.getCapabilities() : null;
        }

        const lines = [];
        lines.push(`UA: ${uaFull}`);
        lines.push(`BarcodeDetector: ${supportsNative ? 'disponibile (nativo o polyfill)' : 'assente'}`);
        if (supFormats.length) lines.push(`Formati BD: ${supFormats.join(', ')}`);
        lines.push(`Constraints supportati: ${Object.keys(sc).filter(k=>sc[k]).join(', ') || '(n/d)'}`);
        if (settings) lines.push(`Video corrente: ${settings.width || '?'}x${settings.height || '?'} @ ${settings.frameRate || '?'}fps`);
        if (caps) {
          const torch = caps.torch ? 'si' : 'no';
          const zoom = caps.zoom ? `si (min:${caps.zoom.min}, max:${caps.zoom.max})` : 'no';
          lines.push(`Torch: ${torch} | Zoom: ${zoom}`);
        }
        els.diag.textContent = lines.join('\n');
      } catch (e) {
        els.diag.textContent = `Diagnostica errore: ${e.message || e}`;
      }
    }
  </script>
</body>
</html>
